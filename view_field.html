<body data-url="$1225050902$">
    <p>ğŸ”„ Fetching from URL set in attribute...</p>
    <script>
        async function fetchFromDynamicAttribute() {
        const url = document.body.getAttribute('data-url');
        if (!url || url.includes('$')) {
            sendError('No valid URL found in the attribute.');
            return;
        }

        console.log('ğŸ”— Starting fetch:', url);
        await attemptFetch(url, false);
        }

        async function attemptFetch(url, hasRetried) {
        try {
            const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
            });

            console.log('ğŸ“¥ Fetch complete, status:', response.status);

            if (response.status === 401 && !hasRetried) {
            console.warn('ğŸ” Unauthorized â€“ trying to establish session...');
            const baseUrl = extractBaseUrl(url);

            // Do login/session trigger call
            const loginResponse = await fetch(baseUrl, {
                method: 'GET',
                credentials: 'include'
            });

            console.log('ğŸ” Session trigger response:', loginResponse.status);

            // Try original request again
            return await attemptFetch(url, true);
            }

            if (!response.ok) {
            throw new Error(`HTTP error: ${response.status}`);
            }

            const data = await response.json();
            console.log('ğŸ“¦ Data received:', data);

            const payload = JSON.stringify(data);

            if (parent?.DView?.SendSignalToParent) {
            console.log('ğŸ“¤ Sending AREvent FetchResult to the form');
            parent.DView.SendSignalToParent(undefined, 'FetchResult', payload);
            }

        } catch (err) {
            sendError(err.message);
        }
        }

        function extractBaseUrl(fullUrl) {
        try {
            const parsed = new URL(fullUrl);
            return `${parsed.protocol}//${parsed.host}`;
        } catch (e) {
            console.error('âŒ Failed to parse URL:', fullUrl);
            return fullUrl;
        }
        }

        function sendError(message) {
        if (parent?.DView?.SendSignalToParent) {
            parent.DView.SendSignalToParent(undefined, 'FetchError', message);
        }
        }
  
      window.addEventListener('DOMContentLoaded', fetchFromDynamicAttribute);
    </script>
  </body>
  